<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Sale Invoice</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-header h1 { margin: 0; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-row > div { flex: 1; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        #invoice-items-table input { width: 90%; padding: 5px; }
        #grand-total { text-align: right; font-size: 1.2em; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1>New Sale Invoice</h1>
        <a href="sale.html" target="content-frame" class="btn btn-secondary">Back to List</a>
    </div>
    <hr>
    <div>
        <div class="form-row">
            <div><label><b>Select Firm:</b> </label><select id="company-switcher"></select></div>
            <div><label for="invoice-date">Invoice Date:</label><input type="date" id="invoice-date" style="width:100%; padding: 8px;"></div>
        </div>
        <div class="form-row">
             <div><label for="party-selector">Select Customer:</label><select id="party-selector" style="width:100%; padding: 8px;"></select></div>
        </div>
        <table id="invoice-items-table">
            <thead><tr><th>Item</th><th style="width: 15%;">Qty</th><th style="width: 20%;">Price</th><th style="width: 20%;">Total</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
        <button id="add-item-btn" style="margin-top: 10px;">+ Add Item</button>
        <div id="grand-total">Grand Total: ₹0.00</div>
        <button id="save-invoice-btn" class="btn btn-primary" style="margin-top: 20px;">Save Invoice</button>
    </div>
</div>

<script>
let activeCompanyId = null; let allItems = []; let allParties = [];
const companySwitcher = document.getElementById('company-switcher');
const partySelector = document.getElementById('party-selector');
const invoiceDateEl = document.getElementById('invoice-date');
const invoiceItemsTableBody = document.querySelector('#invoice-items-table tbody');

document.addEventListener('DOMContentLoaded', () => {
    const companies = JSON.parse(localStorage.getItem('companies')) || [];
    activeCompanyId = localStorage.getItem('activeCompanyId');
    if (!activeCompanyId) {
        document.body.innerHTML = '<h1>Please select a firm from Settings first.</h1>';
        return;
    }
    companies.forEach(c => { companySwitcher.innerHTML += `<option value="${c.id}">${c.company_name}</option>`; });
    companySwitcher.value = activeCompanyId;
    invoiceDateEl.valueAsDate = new Date();
    loadInitialData();
});

function loadInitialData() {
    allParties = JSON.parse(localStorage.getItem('parties')) || [];
    allItems = JSON.parse(localStorage.getItem('items')) || [];
    populateCustomers();
    resetInvoiceForm();
}

function populateCustomers() {
    const companyCustomers = allParties.filter(p => p.companyId == activeCompanyId && p.type === 'Customer');
    partySelector.innerHTML = '<option value="">-- Select Customer --</option>';
    companyCustomers.forEach(c => { partySelector.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
}

function resetInvoiceForm() {
    partySelector.value = '';
    invoiceDateEl.valueAsDate = new Date();
    invoiceItemsTableBody.innerHTML = '';
    addNewItemRow();
    calculateGrandTotal();
}

document.getElementById('save-invoice-btn').addEventListener('click', () => {
    if (!partySelector.value) { alert('Please select a customer.'); return; }
    const invoiceItems = []; let isValid = true;
    invoiceItemsTableBody.querySelectorAll('tr').forEach(row => {
        const itemId = row.querySelector('.item-selector').value; const qty = parseInt(row.querySelector('.item-qty').value);
        if (itemId && qty > 0) {
            const itemData = allItems.find(i => i.id == itemId);
            if (qty > itemData.stock) { alert(`Not enough stock for '${itemData.name}'! (Available: ${itemData.stock})`); isValid = false; }
            invoiceItems.push({ itemId: itemId, itemName: itemData.name, qty: qty, price: parseFloat(row.querySelector('.item-price').value), total: parseFloat(row.querySelector('.item-total').value) });
        }
    });
    if (!isValid || invoiceItems.length === 0) { if (invoiceItems.length === 0) alert('Please add at least one item.'); return; }
    
    const newSale = { id: Date.now(), date: invoiceDateEl.value, companyId: activeCompanyId, partyId: partySelector.value, items: invoiceItems, totalAmount: parseFloat(document.getElementById('grand-total').textContent.replace('Grand Total: ₹', '')) };
    
    // Update stock
    newSale.items.forEach(soldItem => { const itemIndex = allItems.findIndex(i => i.id == soldItem.itemId); if(itemIndex !== -1) allItems[itemIndex].stock -= soldItem.qty; });
    localStorage.setItem('items', JSON.stringify(allItems));
    
    // Save sale record
    const allSales = JSON.parse(localStorage.getItem('sales')) || []; allSales.push(newSale);
    localStorage.setItem('sales', JSON.stringify(allSales));
    
    alert('Invoice saved successfully!');
    
    // Redirect back to the sales list page
    window.parent.document.getElementById('content-frame').src = 'sale.html';
});

companySwitcher.addEventListener('change', (e) => { activeCompanyId = e.target.value; localStorage.setItem('activeCompanyId', activeCompanyId); loadInitialData(); });

// Helper functions for the form
function addNewItemRow(){const row=document.createElement("tr"),companyItems=allItems.filter(e=>e.companyId==activeCompanyId);let t='<option value="">-- Select Item --</option>';companyItems.forEach(e=>{t+=`<option value="${e.id}" data-price="${e.price}">${e.name} (Stock: ${e.stock})</option>`}),row.innerHTML=`<td><select class="item-selector">${t}</select></td><td><input type="number" class="item-qty" value="1" min="1"></td><td><input type="number" class="item-price" readonly></td><td><input type="text" class="item-total" readonly></td><td><button onclick="this.parentElement.parentElement.remove(); calculateGrandTotal();">X</button></td>`,invoiceItemsTableBody.appendChild(row),row.querySelector(".item-selector").addEventListener("change",updateRowOnItemSelect),row.querySelector(".item-qty").addEventListener("input",calculateRowTotal)}
function updateRowOnItemSelect(e){const t=e.target,o=t.options[t.selectedIndex].getAttribute("data-price"),l=t.closest("tr");l.querySelector(".item-price").value=o,calculateRowTotal.call(l.querySelector(".item-qty"))}
function calculateRowTotal(){const e=this.closest("tr"),t=parseFloat(e.querySelector(".item-qty").value)||0,o=parseFloat(e.querySelector(".item-price").value)||0;e.querySelector(".item-total").value=(t*o).toFixed(2),calculateGrandTotal()}
function calculateGrandTotal(){let e=0;document.querySelectorAll("#invoice-items-table tbody tr").forEach(t=>{e+=parseFloat(t.querySelector(".item-total").value)||0}),document.getElementById("grand-total").textContent=`Grand Total: ₹${e.toFixed(2)}`}
document.getElementById('add-item-btn').addEventListener('click', addNewItemRow);
</script>
</body>
</html>
