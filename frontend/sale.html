<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale Invoices</title>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.14/dist/jspdf.plugin.autotable.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-header h1 { margin: 0; }
        .btn-primary { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; text-decoration: none; }
        .filter-bar { display: flex; gap: 10px; align-items: center; background-color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .summary-box { background-color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-around; }
        .summary-item { text-align: center; }
        .summary-item .title { color: #6c757d; font-size: 0.9em; }
        .summary-item .value { font-size: 1.5em; font-weight: 600; }
        .transactions-table { width: 100%; border-collapse: collapse; background-color: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .transactions-table th, .transactions-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .transactions-table th { background-color: #f8f9fa; }
        .status { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500; }
        .status-paid { background-color: #d4edda; color: #155724; }
        .status-overdue { background-color: #f8d7da; color: #721c24; }
        .status-unpaid { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1>Sale Invoices</h1>
        <a href="create_sale.html" target="content-frame" class="btn-primary">+ Add Sale</a>
    </div>
    <div class="filter-bar">
        <label>Filter by Date:</label>
        <input type="date" id="start-date">
        <input type="date" id="end-date">
        <button id="filter-btn">Apply</button>
    </div>
    <div class="summary-box">
        <div class="summary-item"><div class="title">TOTAL SALES AMOUNT</div><div id="total-sales" class="value">â‚¹0.00</div></div>
        <div class="summary-item"><div class="title">RECEIVED</div><div id="total-received" class="value">â‚¹0.00</div></div>
        <div class="summary-item"><div class="title">BALANCE</div><div id="total-balance" class="value">â‚¹0.00</div></div>
    </div>
    <table class="transactions-table">
        <thead>
            <tr><th>Date</th><th>Invoice No</th><th>Party Name</th><th>Amount</th><th>Balance</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="sales-list-body"></tbody>
    </table>
</div>

<script>
window.jsPDF = window.jspdf.jsPDF;
let activeCompanyId = null;
let allSales = [], allParties = [], allTransactions = [];

document.addEventListener('DOMContentLoaded', () => {
    activeCompanyId = localStorage.getItem('activeCompanyId');
    if (!activeCompanyId) {
        document.body.innerHTML = '<h1>Please select a firm first.</h1>';
        return;
    }
    loadAllData();
    renderSalesList();
    document.getElementById('filter-btn').addEventListener('click', renderSalesList);
});

function loadAllData() {
    allSales = JSON.parse(localStorage.getItem('sales')) || [];
    allParties = JSON.parse(localStorage.getItem('parties')) || [];
    allTransactions = JSON.parse(localStorage.getItem('transactions')) || [];
}

function getInvoiceBalance(sale) {
    const paymentsForParty = allTransactions.filter(t => t.type === 'PaymentIn' && t.partyId == sale.partyId);
    const totalPaid = paymentsForParty.reduce((sum, p) => sum + p.amount, 0);
    // This is a simplified logic. For true invoice-wise balance, each payment must be linked to an invoice.
    // For now, we assume payments clear oldest debts first.
    // This part needs a much more complex logic for 100% accuracy, but this is a good start.
    const salesForParty = allSales.filter(s => s.partyId == sale.partyId).sort((a,b) => new Date(a.date) - new Date(b.date));
    
    let pendingAmount = 0;
    let paidAmountTracker = totalPaid;
    for(const s of salesForParty) {
        let billPaidAmount = Math.min(paidAmountTracker, s.totalAmount);
        pendingAmount += (s.totalAmount - billPaidAmount);
        paidAmountTracker -= billPaidAmount;
        if(s.id === sale.id) {
            return s.totalAmount - billPaidAmount;
        }
    }
    return sale.totalAmount; // Fallback
}

function renderSalesList() {
    const companySales = allSales.filter(s => s.companyId == activeCompanyId);
    const tableBody = document.getElementById('sales-list-body');
    tableBody.innerHTML = '';

    let totalSalesAmt = 0, totalReceivedAmt = 0;

    companySales.forEach(sale => {
        const party = allParties.find(p => p.id == sale.partyId) || { name: 'N/A' };
        const balance = getInvoiceBalance(sale); // Simplified balance calculation
        let statusHtml = '';
        if (balance <= 0) {
            statusHtml = '<span class="status status-paid">Paid</span>';
        } else if (new Date(sale.date) < new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)) { // Example: due in 30 days
            statusHtml = '<span class="status status-overdue">Overdue</span>';
        } else {
            statusHtml = '<span class="status status-unpaid">Unpaid</span>';
        }
        
        tableBody.innerHTML += `
            <tr>
                <td>${new Date(sale.date).toLocaleDateString()}</td>
                <td>${sale.id}</td>
                <td>${party.name}</td>
                <td>â‚¹${sale.totalAmount.toFixed(2)}</td>
                <td>â‚¹${balance.toFixed(2)}</td>
                <td>${statusHtml}</td>
                <td>
                    <button onclick="generateInvoicePDF(${sale.id})">ðŸ“„</button> <!-- Print Icon -->
                </td>
            </tr>
        `;
        totalSalesAmt += sale.totalAmount;
        totalReceivedAmt += (sale.totalAmount - balance);
    });

    document.getElementById('total-sales').textContent = `â‚¹${totalSalesAmt.toFixed(2)}`;
    document.getElementById('total-received').textContent = `â‚¹${totalReceivedAmt.toFixed(2)}`;
    document.getElementById('total-balance').textContent = `â‚¹${(totalSalesAmt - totalReceivedAmt).toFixed(2)}`;
}

function generateInvoicePDF(saleId) { /* ... This function is unchanged ... */ }
</script>
</body>
</html>
